# Claude Codeã§ã®é–‹ç™ºã‚¬ã‚¤ãƒ‰

## æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€RRFusionãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’Claude Codeã§é–‹ç™ºã™ã‚‹éš›ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨æ¨å¥¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç‰¹å¾´

RRFusionã¯ã€Codex(Anthropicç¤¾ã®AIé–‹ç™ºãƒ„ãƒ¼ãƒ«)ã§é–‹ç™ºã•ã‚ŒãŸç‰¹è¨±æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ ã§ã€ä»¥ä¸‹ã®ç‰¹å¾´ãŒã‚ã‚Šã¾ã™:

### æŠ€è¡“çš„ç‰¹å¾´
- **è¤‡æ•°ãƒ¬ãƒ¼ãƒ³æ¤œç´¢**: fulltext, semantic, code-basedãªã©è¤‡æ•°ã®æ¤œç´¢æˆ¦ç•¥ã‚’ä¸¦åˆ—å®Ÿè¡Œ
- **RRFèåˆ**: Reciprocal Rank Fusionã§æ¤œç´¢çµæœã‚’çµ±åˆ
- **ã‚³ãƒ¼ãƒ‰èªè­˜ãƒ©ãƒ³ã‚­ãƒ³ã‚°**: FI/FT/CPC/IPCãªã©ç‰¹è¨±åˆ†é¡ã‚³ãƒ¼ãƒ‰ã‚’æ´»ç”¨ã—ãŸç²¾ç·»ãªã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
- **MCPçµ±åˆ**: Model Context ProtocolçµŒç”±ã§LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«æ¤œç´¢æ©Ÿèƒ½ã‚’æä¾›
- **Redisé«˜é€ŸåŒ–**: ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§é«˜é€Ÿãªèåˆæ¼”ç®—ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½“ç³»
RRFusionã¯éå¸¸ã«å……å®Ÿã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æŒã£ã¦ã„ã¾ã™:

1. **[AGENT.md](AGENT.md)**: å®Ÿè£…ä»•æ§˜ã¨APIå®šç¾©
2. **[SystemPrompt.yaml](src/rrfusion/SystemPrompt.yaml)**: LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œä»•æ§˜(ç´„700è¡Œ)
3. **[RRFusionSpecification.md](src/rrfusion/RRFusionSpecification.md)**: æ•°ç†çš„èƒŒæ™¯ã¨è¨­è¨ˆå“²å­¦

## Claude Codeã§ã®é–‹ç™ºæˆ¦ç•¥

### 1. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé§†å‹•é–‹ç™º

#### é–‹ç™ºå‰ã®ç¢ºèªäº‹é …
æ–°æ©Ÿèƒ½é–‹ç™ºã‚„ãƒã‚°ä¿®æ­£ã‚’å§‹ã‚ã‚‹å‰ã«ã€å¿…ãšé–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„:

```mermaid
graph LR
    A[è¦ä»¶/Issue] --> B{ã©ã®é ˜åŸŸ?}
    B -->|MCP API| C[AGENT.md]
    B -->|LLMå‹•ä½œ| D[SystemPrompt.yaml]
    B -->|ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ | E[RRFusionSpec.md]
    B -->|FIå‡¦ç†| F[fi-improvement.md]
    C --> G[å®Ÿè£…]
    D --> G
    E --> G
    F --> G
```

#### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã®å¿…è¦æ€§
ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ãŸã‚‰ã€å¯¾å¿œã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚æ›´æ–°ã—ã¦ãã ã•ã„:

| ã‚³ãƒ¼ãƒ‰å¤‰æ›´å†…å®¹ | æ›´æ–°ãŒå¿…è¦ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ |
|--------------|---------------------|
| MCPãƒ„ãƒ¼ãƒ«è¿½åŠ /å¤‰æ›´ | AGENT.md + SystemPrompt.yaml |
| ãƒ¬ãƒ¼ãƒ³è¨­è¨ˆå¤‰æ›´ | SystemPrompt.yaml + RRFusionSpec.md |
| èåˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å¤‰æ›´ | RRFusionSpec.md + fusion.py docstrings |
| FIå‡¦ç†å¤‰æ›´ | fi-improvement.md + storage.py docstrings |

### 2. ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥é–‹ç™ºã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

RRFusionã¯æ˜ç¢ºãªãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ã‚’æŒã£ã¦ã„ã¾ã™:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LLM Agent Layer                 â”‚  â† SystemPrompt.yaml
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MCP Tools Layer                 â”‚  â† mcp/host.py
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Business Logic Layer            â”‚  â† mcp/service.py
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Fusion Engine Layer             â”‚  â† fusion.py
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Storage Layer                   â”‚  â† storage.py
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Backend Adapter Layer           â”‚  â† backends/
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é–‹ç™ºã®ãƒã‚¤ãƒ³ãƒˆ**:
- å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æ˜ç¢ºã«åˆ†é›¢ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å½±éŸ¿ç¯„å›²ã‚’æŠŠæ¡ã—ã‚„ã™ã„
- ä¸‹ä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¤‰æ›´ã¯ä¸Šä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ†ã‚¹ãƒˆã§æ¤œè¨¼ã•ã‚Œã‚‹
- ä¸Šä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¤‰æ›´ã§ã‚‚ã€ä»•æ§˜æ›¸ã¨ã®æ•´åˆæ€§ç¢ºèªãŒé‡è¦

### 3. ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™º

#### ãƒ†ã‚¹ãƒˆæˆ¦ç•¥
```bash
# 1. æœ€é€Ÿ: ãƒªãƒ³ãƒˆãƒã‚§ãƒƒã‚¯(æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã®æ—©æœŸç™ºè¦‹)
cargo make lint

# 2. é«˜é€Ÿ: å˜ä½“ãƒ†ã‚¹ãƒˆ(ãƒ­ã‚¸ãƒƒã‚¯æ¤œè¨¼ã€å¤–éƒ¨ä¾å­˜ãªã—)
cargo make unit

# 3. ä¸­é€Ÿ: çµ±åˆãƒ†ã‚¹ãƒˆ(Redis+MCPã€HTTPãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆãªã—)
cargo make integration

# 4. ä½é€Ÿ: E2Eãƒ†ã‚¹ãƒˆ(å®Œå…¨ãªFastMCPã‚¹ã‚¿ãƒƒã‚¯)
cargo make e2e

# 5. å…¨å®Ÿè¡Œ: CIç’°å¢ƒã¨åŒã˜ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ
cargo make ci
```

#### é–‹ç™ºãƒ«ãƒ¼ãƒ—ã®æ¨å¥¨ãƒ•ãƒ­ãƒ¼
```bash
# é–‹ç™ºä¸­(é »ç¹ã«å®Ÿè¡Œ)
cargo make lint      # æ•°ç§’
cargo make unit      # æ•°åç§’

# ã‚³ãƒŸãƒƒãƒˆå‰(å¿…é ˆ)
cargo make integration  # 1-2åˆ†
cargo make e2e         # 2-3åˆ†

# PRãƒãƒ¼ã‚¸å‰(CIç¢ºèª)
cargo make ci          # 5-10åˆ†
```

### 4. Claude Code Skillsã®æ´»ç”¨

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®skillsã‚’ `.claude/skills/` ã«ç”¨æ„ã—ã¾ã—ãŸ:

#### [test-workflow.md](.claude/skills/test-workflow.md)
**ä½¿ã„ã©ã“ã‚**: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ãƒ‡ãƒãƒƒã‚°

```bash
# ä½¿ç”¨ä¾‹
# "test-workflow skillã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦"
```

#### [spec-check.md](.claude/skills/spec-check.md)
**ä½¿ã„ã©ã“ã‚**: ã‚³ãƒ¼ãƒ‰ã¨ä»•æ§˜æ›¸ã®æ•´åˆæ€§ç¢ºèª

```bash
# ä½¿ç”¨ä¾‹
# "spec-check skillã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´åˆæ€§ã‚’ç¢ºèªã—ã¦"
```

#### [lane-design.md](.claude/skills/lane-design.md)
**ä½¿ã„ã©ã“ã‚**: æ¤œç´¢ãƒ¬ãƒ¼ãƒ³ã®è¨­è¨ˆã¨å®Ÿè£…

```bash
# ä½¿ç”¨ä¾‹
# "lane-design skillã‚’å‚ç…§ã—ã¦æ–°ã—ã„ãƒ¬ãƒ¼ãƒ³ã‚’è¿½åŠ ã—ã¦"
```

#### [redis-debug.md](.claude/skills/redis-debug.md)
**ä½¿ã„ã©ã“ã‚**: Redisãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ãƒ‡ãƒãƒƒã‚°

```bash
# ä½¿ç”¨ä¾‹
# "redis-debug skillã‚’ä½¿ã£ã¦fusionçµæœã‚’ç¢ºèªã—ã¦"
```

#### [mcp-development.md](.claude/skills/mcp-development.md)
**ä½¿ã„ã©ã“ã‚**: MCPãƒ„ãƒ¼ãƒ«ã®é–‹ç™º

```bash
# ä½¿ç”¨ä¾‹
# "mcp-development skillã‚’å‚ç…§ã—ã¦æ–°ã—ã„ãƒ„ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¦"
```

#### [fusion-algorithm.md](.claude/skills/fusion-algorithm.md)
**ä½¿ã„ã©ã“ã‚**: èåˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ç†è§£ã¨å®Ÿè£…

```bash
# ä½¿ç”¨ä¾‹
# "fusion-algorithm skillã‚’å‚ç…§ã—ã¦RRFã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã—ã¦"
```

## æ¨å¥¨é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

### æ–°æ©Ÿèƒ½é–‹ç™ºã®å ´åˆ

```mermaid
graph TD
    A[Issue/è¦ä»¶] --> B[é–¢é€£ä»•æ§˜æ›¸ã‚’èª­ã‚€]
    B --> C[è¨­è¨ˆã‚’æ¤œè¨]
    C --> D[skillsã§å®Ÿè£…ã‚¬ã‚¤ãƒ‰ç¢ºèª]
    D --> E[ã‚³ãƒ¼ãƒ‰å®Ÿè£…]
    E --> F[å˜ä½“ãƒ†ã‚¹ãƒˆè¿½åŠ ]
    F --> G[cargo make unit]
    G --> H{Pass?}
    H -->|No| E
    H -->|Yes| I[çµ±åˆãƒ†ã‚¹ãƒˆè¿½åŠ ]
    I --> J[cargo make integration]
    J --> K{Pass?}
    K -->|No| E
    K -->|Yes| L[ä»•æ§˜æ›¸æ›´æ–°]
    L --> M[spec-check skillã§ç¢ºèª]
    M --> N[cargo make ci]
    N --> O{Pass?}
    O -->|No| E
    O -->|Yes| P[ã‚³ãƒŸãƒƒãƒˆ]
```

### ãƒã‚°ä¿®æ­£ã®å ´åˆ

```mermaid
graph TD
    A[ãƒã‚°å ±å‘Š] --> B[å†ç¾ãƒ†ã‚¹ãƒˆä½œæˆ]
    B --> C[cargo make integration/e2e]
    C --> D{å†ç¾ã—ãŸ?}
    D -->|No| B
    D -->|Yes| E[ãƒ‡ãƒãƒƒã‚°]
    E --> F{åŸå› ç‰¹å®š}
    F -->|Redis| G[redis-debug skillä½¿ç”¨]
    F -->|Fusion| H[fusion-algorithm skillä½¿ç”¨]
    F -->|MCP| I[mcp-development skillä½¿ç”¨]
    G --> J[ä¿®æ­£å®Ÿè£…]
    H --> J
    I --> J
    J --> K[ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ]
    K --> L{Pass?}
    L -->|No| J
    L -->|Yes| M[ä»•æ§˜æ›¸ç¢ºèª]
    M --> N[spec-check skill]
    N --> O[ã‚³ãƒŸãƒƒãƒˆ]
```

## é‡è¦ãªé–‹ç™ºåŸå‰‡

### ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ç†è§£

RRFusionã¯**LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**ï¼ˆClaudeã‚„GPTãªã©ï¼‰ãŒ[SystemPrompt.yaml](src/rrfusion/SystemPrompt.yaml)ã§å®šç¾©ã•ã‚ŒãŸæ¤œç´¢æˆ¦ç•¥ã«å¾“ã£ã¦ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’å‰æã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚Claude Codeé–‹ç™ºè€…ã¨ã—ã¦ã®å½¹å‰²ã¯:

1. **ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®å®Ÿè£…**: LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå¿…è¦ã¨ã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›
2. **ä»•æ§˜ã¨ã®æ•´åˆæ€§ç¶­æŒ**: ã‚³ãƒ¼ãƒ‰ã¨ä»•æ§˜æ›¸(AGENT.mdã€SystemPrompt.yaml)ã®ä¸€è²«æ€§ã‚’ä¿ã¤
3. **ã‚·ã‚¹ãƒ†ãƒ ã®æ­£ã—ã„å‹•ä½œä¿è¨¼**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé€šã‚Šã®æŒ™å‹•ã‚’å®Ÿè£…

### ä¸»è¦ãªå®Ÿè£…è¦ä»¶

#### FIæ­£è¦åŒ–ã®ã‚µãƒãƒ¼ãƒˆ

ã‚·ã‚¹ãƒ†ãƒ ã¯**2æ®µéšã®FIå‡¦ç†**ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:

- `fi_norm`: ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¬ãƒ™ãƒ«ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: "G06V10/82"ï¼‰ - ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã«ä½¿ç”¨
- `fi_full`: åˆ†å†Šè­˜åˆ¥è¨˜å·ä»˜ãã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: "G06V10/82A"ï¼‰ - å¼±ã„ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ’ãƒ³ãƒˆã«ä½¿ç”¨

**ãªãœé‡è¦ã‹**: LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®SystemPromptãŒã‚¯ã‚¨ãƒªã§ã“ã‚Œã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã©ã†ä½¿ã†ã‹ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚å®Ÿè£…å´ã¯ä¸¡æ–¹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ­£ã—ãæä¾›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

#### ã‚³ãƒ¼ãƒ‰ä½“ç³»ã®æŸ”è»Ÿãªã‚µãƒãƒ¼ãƒˆ

ã‚·ã‚¹ãƒ†ãƒ ã¯è¤‡æ•°ã®åˆ†é¡ä½“ç³»(FI/FT/CPC/IPC)ã‚’**ç‹¬ç«‹ã—ã¦**ã‚µãƒãƒ¼ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:

- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å±¤: æ–‡æ›¸ã”ã¨ã«å…¨ã¦ã®ã‚³ãƒ¼ãƒ‰ä½“ç³»ã‚’ä¿å­˜
- èåˆå±¤: è¦æ±‚ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ä½“ç³»ã‚’ä½¿ã£ã¦ã‚³ãƒ¼ãƒ‰èªè­˜ãƒ–ãƒ¼ã‚¹ãƒˆã‚’é©ç”¨
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ€ãƒ—ã‚¿: ä½“ç³»ã”ã¨ã«ãƒ•ã‚£ãƒ«ã‚¿ã‚’æ­£ã—ããƒãƒƒãƒ”ãƒ³ã‚°

**ãªãœé‡è¦ã‹**: LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç®¡è½„ã«å¿œã˜ã¦ï¼ˆJPâ†’FI/FTã€US/EPâ†’CPC/IPCï¼‰ãƒ¬ãƒ¼ãƒ³ã”ã¨ã«ã‚³ãƒ¼ãƒ‰ä½“ç³»ã‚’é¸æŠã—ã¾ã™ã€‚å®Ÿè£…å´ã¯å…¨ã¦ã®ä½“ç³»ã‚’æ­£ã—ãå‡¦ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

#### ã‚¯ã‚¨ãƒªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®è¨­è¨ˆ

MCPãƒ„ãƒ¼ãƒ«ã¯ä»¥ä¸‹ã‚’å—ã‘å…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:

- `search_fulltext`: æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ–ãƒ¼ãƒ«ã‚¯ã‚¨ãƒªï¼ˆAND/OR/NOT/NEAR/ãƒ•ãƒ¬ãƒ¼ã‚ºï¼‰
- `search_semantic`: è‡ªç„¶è¨€èªãƒ†ã‚­ã‚¹ãƒˆ
- ä¸¡æ–¹: ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ä½“ç³»ã«å¯¾å¿œã™ã‚‹æŸ”è»Ÿãªãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶

**ãªãœé‡è¦ã‹**: LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒ¬ãƒ¼ãƒ³ã”ã¨ã«ç•°ãªã‚‹ã‚¯ã‚¨ãƒªã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚å®Ÿè£…å´ã¯ãã‚Œã‚‰ã‚’æ­£ã—ããƒ‘ãƒ¼ã‚¹ã—ã¦å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### SystemPrompt.yamlã¨ã®é–¢ä¿‚

[SystemPrompt.yaml](src/rrfusion/SystemPrompt.yaml)ã¯**LLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œä»•æ§˜**ã§ã™ã€‚é–‹ç™ºè€…ã¨ã—ã¦ç†è§£ã™ã¹ããƒã‚¤ãƒ³ãƒˆ:

- **lanes ã‚»ã‚¯ã‚·ãƒ§ãƒ³**: ã©ã®ã‚ˆã†ãªãƒ¬ãƒ¼ãƒ³ãŒå­˜åœ¨ã—ã€ã©ã‚“ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ã†ã‹ â†’ å®Ÿè£…å´ã¯ã“ã‚Œã‚‰ã‚’æ­£ã—ãå‡¦ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- **code_usage_policy**: FI/FTã®ä½¿ã„æ–¹ãƒ«ãƒ¼ãƒ« â†’ å®Ÿè£…å´ã¯fi_normã¨fi_fullã®ä¸¡æ–¹ã‚’æä¾›ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- **tool_usage**: å„MCPãƒ„ãƒ¼ãƒ«ã®ä½¿ã‚ã‚Œæ–¹ â†’ å®Ÿè£…å´ã¯ã“ã®ä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- **anti_patterns**: LLMãŒé¿ã‘ã‚‹ã¹ããƒ‘ã‚¿ãƒ¼ãƒ³ â†’ å®Ÿè£…å´ã¯æ­£ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚é–“é•ã£ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚å‡¦ç†ã§ãã‚‹å¿…è¦ãŒã‚ã‚‹

**ä¾‹**: SystemPromptãŒã€ŒFIåˆ†å†Šè­˜åˆ¥è¨˜å·ã‚’MUSTãƒ•ã‚£ãƒ«ã‚¿ã§ä½¿ã†ãªã€ã¨å®šç¾©ã—ã¦ã„ã¦ã‚‚ã€å®Ÿè£…å´ã¯æŠ€è¡“çš„ã«ã¯ä¸¡æ–¹ã®ãƒ•ã‚£ãƒ«ã‚¿æ–¹å¼ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãƒ«ãƒ¼ãƒ«ã¯LLMå´ãŒå®ˆã‚Šã€å®Ÿè£…å´ã¯æŸ”è»Ÿã«å¯¾å¿œã—ã¾ã™ã€‚

## å®Ÿè·µçš„ãªé–‹ç™ºã‚·ãƒŠãƒªã‚ª

### ã‚·ãƒŠãƒªã‚ª1: æ–°ã—ã„MCPãƒ„ãƒ¼ãƒ«ã®è¿½åŠ 

```bash
# 1. ä»•æ§˜ç¢ºèª
cat AGENT.md | grep -A 20 "MCP Tools"

# 2. skillsã§ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ç¢ºèª
# "mcp-development skillã‚’è¦‹ã¦æ–°ãƒ„ãƒ¼ãƒ«ã®è¿½åŠ æ–¹æ³•ã‚’æ•™ãˆã¦"

# 3. ãƒ¢ãƒ‡ãƒ«å®šç¾© (models.py)
class MyNewToolRequest(BaseModel):
    param1: str
    param2: int = 10

class MyNewToolResponse(BaseModel):
    result: str

# 4. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£… (mcp/service.py)
async def my_new_tool(self, req: MyNewToolRequest) -> MyNewToolResponse:
    # ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
    return MyNewToolResponse(result="...")

# 5. FastMCPç™»éŒ² (mcp/host.py)
@mcp.tool
async def my_new_tool(param1: str, param2: int = 10) -> MyNewToolResponse:
    """Tool description for LLM"""
    service = await get_service()
    return await service.my_new_tool(MyNewToolRequest(...))

# 6. SystemPromptæ›´æ–°
# SystemPrompt.yaml ã® tool_usage ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ 

# 7. ãƒ†ã‚¹ãƒˆè¿½åŠ 
# tests/integration/test_my_tool.py

# 8. å®Ÿè¡Œ
cargo make integration

# 9. ä»•æ§˜æ›¸æ›´æ–°ç¢ºèª
# "spec-check skillã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ã‚’ç¢ºèªã—ã¦"

# 10. CIç¢ºèª
cargo make ci
```

### ã‚·ãƒŠãƒªã‚ª2: èåˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

```bash
# 1. ç¾çŠ¶åˆ†æ
# "redis-debug skillã‚’ä½¿ã£ã¦fusionçµæœã‚’ç¢ºèªã—ã¦"

# 2. ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ç†è§£
# "fusion-algorithm skillã‚’å‚ç…§ã—ã¦LAS/CCW/S-shapeã®æ„å‘³ã‚’èª¬æ˜ã—ã¦"

# 3. å•é¡Œè¨ºæ–­
# ä¾‹: LASãŒä½ã„ â†’ ãƒ¬ãƒ¼ãƒ³é–“ã®ä¸ä¸€è‡´
# ä¾‹: CCWãŒä½ã„ â†’ ã‚³ãƒ¼ãƒ‰åˆ†å¸ƒãŒåˆ†æ•£
# ä¾‹: S-shapeãŒé«˜ã„ â†’ semanticãƒ¬ãƒ¼ãƒ³ãŒæ”¯é…çš„

# 4. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´ (fusion.py)
# rrf_k, beta_fuse, weightsãªã©ã‚’èª¿æ•´

# 5. ãƒ†ã‚¹ãƒˆ
cargo make unit  # fusion_test.py

# 6. çµ±åˆç¢ºèª
cargo make integration

# 7. RRFusionSpecification.mdæ›´æ–°
# å¤‰æ›´ã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ ¹æ‹ ã‚’è¨˜è¼‰
```

### ã‚·ãƒŠãƒªã‚ª3: æ–°ã—ã„æ¤œç´¢ãƒ¬ãƒ¼ãƒ³ã®è¿½åŠ 

```bash
# 1. ãƒ¬ãƒ¼ãƒ³è¨­è¨ˆ
# "lane-design skillã‚’å‚ç…§ã—ã¦ãƒ¬ãƒ¼ãƒ³è¨­è¨ˆã®æ–¹é‡ã‚’æ•™ãˆã¦"

# 2. SystemPrompt.yamlå®šç¾©
lanes:
  - name: fulltext_custom
    tool: search_fulltext
    purpose: custom_purpose
    parameters:
      field_boosts:
        title: 60
        claim: 20
        desc: 10

# 3. ã‚¯ã‚¨ãƒªç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯æ¤œè¨
# A/B/Cåˆ†è§£ã€ã‚³ãƒ¼ãƒ‰ä½“ç³»é¸æŠ

# 4. çµ±åˆãƒ†ã‚¹ãƒˆ
# tests/integration/test_custom_lane.py

# 5. RRFusionSpecification.mdæ›´æ–°
# æ–°ãƒ¬ãƒ¼ãƒ³ã®ç›®çš„ãƒ»å½¹å‰²ãƒ»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨˜è¼‰

# 6. å®Ÿè¡Œ
cargo make integration
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹

```bash
# 1. ã©ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸã‹ç¢ºèª
cargo make lint       # æ§‹æ–‡ã‚¨ãƒ©ãƒ¼?
cargo make unit       # ãƒ­ã‚¸ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼?
cargo make integration # Redis/MCPçµ±åˆã‚¨ãƒ©ãƒ¼?
cargo make e2e        # HTTPãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼?

# 2. integration/e2eã®å ´åˆã€Dockerã‚¹ã‚¿ãƒƒã‚¯ç¢ºèª
docker compose -f infra/compose.ci.yml ps

# 3. å¿…è¦ã«å¿œã˜ã¦å†èµ·å‹•
cargo make stop-ci
cargo make start-ci

# 4. Redisãƒ‡ãƒ¼ã‚¿ç¢ºèª
# "redis-debug skillã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦"

# 5. ä»•æ§˜æ›¸ã¨ã®æ•´åˆæ€§ç¢ºèª
# "spec-check skillã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ã‚’ç¢ºèªã—ã¦"
```

### FusionçµæœãŒãŠã‹ã—ã„

```bash
# 1. Redis ZSETç¢ºèª
docker compose -f infra/compose.ci.yml exec rrfusion-redis redis-cli
ZREVRANGE z:rrf:{run_id} 0 10 WITHSCORES

# 2. ã‚³ãƒ¼ãƒ‰é »åº¦ç¢ºèª
HGETALL h:freq:{run_id}:fulltext

# 3. target_profileç¢ºèª
# get_provenanceã§ç¢ºèª

# 4. æ§‹é€ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¢ºèª
# LAS, CCW, S-shape, Fproxyã®å€¤ã‚’è¦‹ã‚‹

# 5. fusion-algorithm skillã§å…¬å¼ç¢ºèª
# "fusion-algorithm skillã‚’å‚ç…§ã—ã¦RRFã‚¹ã‚³ã‚¢è¨ˆç®—ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦"
```

### MCP Toolå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼

```bash
# 1. ãƒ„ãƒ¼ãƒ«ç½²åç¢ºèª
rg "@mcp\.tool" src/rrfusion/mcp/host.py

# 2. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¢ãƒ‡ãƒ«ç¢ºèª
rg "class.*Request" src/rrfusion/models.py

# 3. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª
# backends/patentfield.py ã¾ãŸã¯ backends/ci.py

# 4. çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
cargo make integration

# 5. mcp-development skillã§ç¢ºèª
# "mcp-development skillã‚’å‚ç…§ã—ã¦ãƒ„ãƒ¼ãƒ«å®Ÿè£…ã‚’ç¢ºèªã—ã¦"
```

## ä¾¿åˆ©ãªã‚³ãƒãƒ³ãƒ‰é›†

### é–‹ç™ºç’°å¢ƒ

```bash
# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
uv sync --all-packages

# ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
uv run fastmcp run --transport http src/rrfusion/mcp/host.py

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl http://localhost:3000/healthz
```

### Dockerç’°å¢ƒ

```bash
# CIç’°å¢ƒèµ·å‹•
cargo make start-ci

# ãƒ­ã‚°ç¢ºèª
cargo make logs

# åœæ­¢
cargo make stop-ci

# ã‚¯ãƒªãƒ¼ãƒ³ãƒ“ãƒ«ãƒ‰
docker compose -f infra/compose.ci.yml up -d --build --force-recreate
```

### Redisæ“ä½œ

```bash
# Redis CLIæ¥ç¶š
docker compose -f infra/compose.ci.yml exec rrfusion-redis redis-cli

# å…¨ã‚­ãƒ¼ç¢ºèª
KEYS *

# Lane ZSETç¢ºèª
ZREVRANGE z:{snapshot}:{hash}:fulltext 0 9 WITHSCORES

# Fusion ZSETç¢ºèª
ZREVRANGE z:rrf:{run_id} 0 9 WITHSCORES

# Codeé »åº¦ç¢ºèª
HGETALL h:freq:{run_id}:fulltext

# Run metadataç¢ºèª
HGETALL h:run:{run_id}
```

### ã‚³ãƒ¼ãƒ‰æ¤œç´¢

```bash
# FIæ­£è¦åŒ–ã®ä½¿ç”¨ç®‡æ‰€
rg "fi_norm" src/

# åˆ†å†Šè­˜åˆ¥è¨˜å·ã®MUSTä½¿ç”¨ãƒã‚§ãƒƒã‚¯(ã‚ã£ã¦ã¯ã„ã‘ãªã„)
rg "fi_full.*MUST" src/ || echo "OK: åˆ†å†Šè­˜åˆ¥è¨˜å·ã¯MUSTã§ä½¿ã‚ã‚Œã¦ã„ã¾ã›ã‚“"

# MCP toolå®šç¾©ç¢ºèª
rg "@mcp\.tool" src/rrfusion/mcp/host.py

# SystemPromptæ§‹æ–‡ç¢ºèª
python -c "import yaml; yaml.safe_load(open('src/rrfusion/SystemPrompt.yaml'))"
```

## ã¾ã¨ã‚: Claude Codeã§ã®é–‹ç™ºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ã‚³ãƒŸãƒƒãƒˆå‰ã«ç¢ºèªã™ã¹ãé …ç›®:

- [ ] é–¢é€£ã™ã‚‹ä»•æ§˜æ›¸ã‚’èª­ã‚“ã ï¼ˆAGENT.mdã€SystemPrompt.yamlã€RRFusionSpec.mdï¼‰
- [ ] é©åˆ‡ãªskillsã‚’å‚ç…§ã—ãŸ
- [ ] å®Ÿè£…ãŒAGENT.mdã®ä»•æ§˜é€šã‚Šã«å‹•ä½œã™ã‚‹
- [ ] SystemPrompt.yamlã§å®šç¾©ã•ã‚ŒãŸLLMã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹
- [ ] FIæ­£è¦åŒ–ã‚¤ãƒ³ãƒ•ãƒ©ï¼ˆfi_norm/fi_fullä¸¡æ–¹ã®ã‚µãƒãƒ¼ãƒˆï¼‰ãŒæ­£ã—ãå‹•ä½œï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸/èåˆå±¤ã‚’å¤‰æ›´ã—ãŸå ´åˆï¼‰
- [ ] è¤‡æ•°ã®ã‚³ãƒ¼ãƒ‰ä½“ç³»ï¼ˆFI/FT/CPC/IPCï¼‰ã‚’ç‹¬ç«‹ã—ã¦å‡¦ç†ã§ãã‚‹
- [ ] `cargo make lint` ãŒé€šã‚‹
- [ ] `cargo make unit` ãŒé€šã‚‹
- [ ] `cargo make integration` ãŒé€šã‚‹
- [ ] `cargo make e2e` ãŒé€šã‚‹
- [ ] ä»•æ§˜æ›¸ã‚’æ›´æ–°ã—ãŸï¼ˆå¿…è¦ãªå ´åˆï¼‰
- [ ] spec-check skillã§æ•´åˆæ€§ç¢ºèªã—ãŸ

---

**Happy Coding with Claude Code!** ğŸš€

è©³ç´°ãªã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã¯ `.claude/README.md` ãŠã‚ˆã³å„skillsã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
