[env]
MCP_EXTERNAL_NETWORK = "rrfusion-test-net"

# --- 基本タスク ---

[tasks.build-cli]
description = "Build the FastMCP CLI image used by integration and e2e scripts."
script = [
    "docker build -f apps/mcp-host/Dockerfile -t infra-rrfusion-tests ."
]

[tasks.start-stub]
description = "Start the stub-based stack (for local E2E testing)."
dependencies = ["build-cli"]
script = [
    "bash -c 'set -a && source infra/.env && set +a && docker compose -f infra/compose.stub.yml up -d --force-recreate --build rrfusion-redis rrfusion-db-stub rrfusion-mcp'"
]

[tasks.stop-stub]
description = "Stop the stub-based stack."
script = [
    "bash -c 'set -a && source infra/.env && set +a && docker compose -f infra/compose.stub.yml down'"
]

[tasks.start-prod]
description = "Start the production-like Redis + MCP stack."
dependencies = ["build-cli"]
script = [
    "bash -c 'set -a && source infra/.env && set +a && docker compose -f infra/compose.prod.yml up -d --force-recreate --build rrfusion-redis rrfusion-mcp'"
]

[tasks.stop-prod]
description = "Stop the production-like stack."
script = [
    "bash -c 'set -a && source infra/.env && set +a && docker compose -f infra/compose.prod.yml down'"
]

[tasks.start-ci]
description = "Start the tightly encapsulated CI stack using infra/compose.ci.yml."
dependencies = ["build-cli"]
script = [
    "bash -c 'set -a && source infra/.env && set +a && docker compose -f infra/compose.ci.yml up -d --force-recreate --build rrfusion-redis rrfusion-db-stub rrfusion-mcp rrfusion-tests'"
]

[tasks.stop-ci]
description = "Stop the CI stack started from infra/compose.ci.yml."
script = [
    "bash -c 'set -a && source infra/.env && set +a && docker compose -f infra/compose.ci.yml down'"
]

# --- テストタスク ---

[tasks.integration]
description = "Run the integration suite against the closed CI stack."
script = [
    "cargo make start-ci",
    "docker compose -f infra/compose.ci.yml exec -T rrfusion-tests pytest -m integration",
    "cargo make stop-ci"
]

[tasks.e2e]
description = "Run the FastMCP CLI e2e suite against the closed CI stack."
script = [
    "cargo make start-ci",
    "docker compose -f infra/compose.ci.yml exec -T rrfusion-tests pytest -m e2e",
    "cargo make stop-ci"
]

# --- CI/CD フロー ---

[tasks.lint]
description = "Run lint checks"
dependencies = ["build-cli"]
command = "docker"
args = [
    "run",
    "--rm",
    "--env-file",
    "infra/.env",
    "infra-rrfusion-tests",
    "ruff",
    "check",
    "src",
    "tests",
    "apps",
    "infra"
]

[tasks.unit]
description = "Run unit tests"
dependencies = ["build-cli"]
command = "docker"
args = [
    "run",
    "--rm",
    "--env-file",
    "infra/.env",
    "infra-rrfusion-tests",
    "bash",
    "-c",
    "pytest -m unit || true"
]

[tasks.ci]
description = "Run full CI suite (lint, unit, integration, e2e)"
script = [
    "cargo make lint",
    "cargo make unit",
    "cargo make integration",
    "cargo make e2e"
]
